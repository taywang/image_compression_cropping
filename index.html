<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>图片批量缩放压缩打包</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        padding: 30px;
        max-width: 1000px;
        margin: auto;
        background: #f0f2f5;
        color: #333;
      }
      h1 {
        text-align: center;
        color: #444;
        margin-bottom: 5px;
      }
      #pngTip {
        text-align: center;
        font-size: 12px;
        color: #f44336;
        margin-bottom: 15px;
        text-decoration: underline;
        font-weight: 600;
      }
      #progressContainer {
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
        display: none;
      }
      #progressBar {
        width: 80%;
        height: 20px;
        border-radius: 8px;
        overflow: hidden;
        appearance: none;
      }
      #progressBar::-webkit-progress-bar {
        background-color: #ddd;
        border-radius: 8px;
      }
      #progressBar::-webkit-progress-value {
        background-color: #4caf50;
        border-radius: 8px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      #controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
        align-items: center;
      }
      #controls label {
        font-size: 14px;
        color: #555;
      }
      #controls input[type="number"] {
        width: 100px;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-left: 6px;
      }
      #controls input[type="checkbox"] {
        margin-left: 6px;
        transform: scale(1.1);
      }
      button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: #42a5f5;
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #2196f3;
      }
      #dropArea {
        width: 100%;
        min-height: 120px;
        border: 2px dashed #bbb;
        border-radius: 12px;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-bottom: 20px;
        color: #777;
        font-size: 15px;
        transition: all 0.2s;
      }
      #dropArea.hover {
        border-color: #2196f3;
        color: #2196f3;
        background: #f0faff;
      }
      #fileList {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #fileList th,
      #fileList td {
        padding: 10px;
        text-align: center;
        font-size: 14px;
      }
      #fileList thead {
        background: #e2e6ea;
        color: #333;
        border-bottom: 1px solid #ccc;
      }
      #fileList tr:nth-child(even) {
        background: #f5f6f7;
      }
      #fileList tr:nth-child(odd) {
        background: #ffffff;
      }
      #fileList img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #ddd;
        cursor: pointer;
      }
      #status {
        margin-top: 15px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
        color: #333;
      }
      .deleteBtn {
        background: #f44336;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      .deleteBtn:hover {
        background: #e53935;
      }
      #previewOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      #previewOverlay img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
      #inputTip {
        text-align: center;
        font-size: 12px;
        color: red;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>图片批量缩放压缩打包</h1>
    <div id="pngTip">PNG图片只处理尺寸，不会压缩！</div>
    <div id="inputTip"></div>

    <div id="progressContainer">
      <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div id="status"></div>

    <div id="controls">
      <label
        >最大尺寸：
        <input type="number" id="maxSize" value="1024" min="128" /> px
      </label>
      <label
        >压缩后质量：
        <input type="number" id="quality" value="80" min="20" max="100" /> %
      </label>
      <label>
        <input type="checkbox" id="keepOriginalSize" /> 保持原尺寸（只压缩）
      </label>
      <button id="startBtn">开始处理</button>
    </div>

    <div id="dropArea">拖拽图片或文件夹到这里，或点击选择</div>
    <input
      type="file"
      id="fileInput"
      multiple
      webkitdirectory
      style="display: none"
    />

    <table id="fileList">
      <thead>
        <tr>
          <th>缩略图</th>
          <th>文件名</th>
          <th>原始尺寸</th>
          <th>处理后尺寸</th>
          <th>原始大小</th>
          <th>处理后大小</th>
          <th>压缩后比例</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="previewOverlay"><img src="" alt="预览图" /></div>

    <script>
      const dropArea = document.getElementById("dropArea");
      const fileInput = document.getElementById("fileInput");
      const status = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const maxSizeInput = document.getElementById("maxSize");
      const qualityInput = document.getElementById("quality");
      const keepOriginalCheckbox = document.getElementById("keepOriginalSize");
      const fileListTable = document.querySelector("#fileList tbody");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const previewOverlay = document.getElementById("previewOverlay");
      const previewImg = previewOverlay.querySelector("img");
      const inputTip = document.getElementById("inputTip");

      let filesList = [];

      // 禁用最大尺寸输入框
      keepOriginalCheckbox.addEventListener("change", () => {
        maxSizeInput.disabled = keepOriginalCheckbox.checked;
        maxSizeInput.style.background = keepOriginalCheckbox.checked
          ? "#eee"
          : "";
      });

      // 输入值检查
      function checkInputValue(input, min, max) {
        let val = parseInt(input.value);
        if (isNaN(val) || val < min) {
          val = min;
          inputTip.textContent = `值不能小于 ${min}, 已自动重置`;
        } else if (max !== undefined && val > max) {
          val = max;
          inputTip.textContent = `值不能大于 ${max}, 已自动重置`;
        } else inputTip.textContent = "";
        input.value = val;
        return val;
      }

      // 添加文件
      dropArea.addEventListener("click", () => fileInput.click());
      dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("hover");
      });
      dropArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropArea.classList.remove("hover");
      });
      dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("hover");
        addFiles(e.dataTransfer.files);
      });
      fileInput.addEventListener("change", (e) => addFiles(e.target.files));

      function addFiles(files) {
        for (let file of files) {
          if (!file.type.startsWith("image/")) continue;
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
              const idx = filesList.length;
              filesList.push({
                file,
                width: img.width,
                height: img.height,
                originalSize: file.size,
              });
              const row = document.createElement("tr");
              row.innerHTML = `
          <td><img src="${img.src}" data-idx="${idx}"></td>
          <td>${file.name}</td>
          <td>${img.width} x ${img.height}</td>
          <td>-</td>
          <td>${(file.size / 1024).toFixed(1)} KB</td>
          <td>-</td>
          <td>-</td>
          <td><button class="deleteBtn" data-index="${idx}">删除</button></td>
        `;
              // 缩略图预览
              row.querySelector("img").addEventListener("click", (e) => {
                const index = e.target.dataset.idx;
                previewImg.src = URL.createObjectURL(filesList[index].file);
                previewOverlay.style.display = "flex";
              });
              // 删除
              row.querySelector("button").addEventListener("click", () => {
                filesList.splice(idx, 1);
                row.remove();
                updateStatus();
              });
              fileListTable.appendChild(row);
              updateStatus();
            };
          };
          reader.readAsDataURL(file);
        }
      }

      previewOverlay.addEventListener(
        "click",
        () => (previewOverlay.style.display = "none")
      );
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") previewOverlay.style.display = "none";
      });

      function updateStatus() {
        status.textContent = `已选择 ${filesList.length} 张图片`;
      }

      async function processImage(file, maxSize, quality, keepOriginal) {
        return new Promise((resolve) => {
          const img = new Image();
          const reader = new FileReader();
          reader.onload = (e) => (img.src = e.target.result);
          img.onload = () => {
            let w = img.width,
              h = img.height;
            if (!keepOriginal) {
              const scale = Math.min(1, maxSize / Math.max(w, h));
              w = Math.round(w * scale);
              h = Math.round(h * scale);
            }
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            if (file.type === "image/png") {
              // 不压缩PNG
              resolve({ blob: file, width: w, height: h });
            } else {
              canvas.toBlob(
                (blob) => resolve({ blob, width: w, height: h }),
                file.type === "image/jpeg" || file.type === "image/jpg"
                  ? "image/jpeg"
                  : file.type,
                quality
              );
            }
          };
          reader.readAsDataURL(file);
        });
      }

      function updateProgress(index, total, row, blob) {
        const percent = Math.round(((index + 1) / total) * 100);
        progressBar.value = percent;
        status.textContent = `已处理 ${index + 1} / ${total} 张`;
        if (row) {
          row.cells[3].textContent = `${row.newWidth} x ${row.newHeight}`;
          row.cells[5].textContent = `${(blob.size / 1024).toFixed(1)} KB`;
          const ratio = ((blob.size / row.originalSize) * 100).toFixed(1);
          row.cells[6].textContent = `${ratio}%`;
        }
      }

      startBtn.addEventListener("click", async () => {
        if (!filesList.length) {
          alert("请先添加图片");
          return;
        }
        const maxSize = checkInputValue(maxSizeInput, 128);
        const quality = checkInputValue(qualityInput, 20, 100) / 100;
        const keepOriginal = keepOriginalCheckbox.checked;
        const zip = new JSZip();

        progressContainer.style.display = "block";
        progressBar.value = 0;

        for (let i = 0; i < filesList.length; i++) {
          const fileObj = filesList[i];
          const row = fileListTable.rows[i];
          row.originalSize = fileObj.originalSize;
          const { blob, width, height } = await processImage(
            fileObj.file,
            maxSize,
            quality,
            keepOriginal
          );
          fileObj.processedSize = blob.size;
          row.newWidth = width;
          row.newHeight = height;
          zip.file(fileObj.file.name, blob);
          updateProgress(i, filesList.length, row, blob);
        }

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(zipBlob);
        const nowDate = new Date();
        link.download = `图片压缩包_${nowDate.toISOString()}.zip`;
        link.click();
        status.textContent = "处理完成，已生成压缩包！";
      });
    </script>
  </body>
</html>
